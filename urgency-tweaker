#!/usr/bin/env python3

import curses
import subprocess
import os
from collections import OrderedDict

RC_PATH = os.path.expanduser("~/.task/config/urgency.rc")

URGENCY_DEFAULTS = OrderedDict({
    "urgency.age": 2.0,
    "urgency.annotations": 1.0,
    "urgency.blocked": -5.0,
    "urgency.blocking": 5.0,
    "urgency.due": 12.0,
    "urgency.priority.H": 6.0,
    "urgency.priority.M": 3.9,
    "urgency.priority.L": 1.8,
    "urgency.project": 1.0,
    "urgency.tags": 1.0,
    "urgency.uda": 1.0,
})

HELP_TEXT = [
    "Arrows: adjust value    q: quit",
    "b: base  p: projects  t: tags  v: virtual-tags  u: udas",
    "Red = deviates from base default",
]

BAR_CHAR = "█"
LIST_WIDTH = 30
BAR_SCALE = 4

# ---------- task helpers ----------

def task_cmd(args):
    try:
        return subprocess.check_output(
            ["task"] + args,
            stderr=subprocess.DEVNULL,
            text=True
        ).splitlines()
    except Exception:
        return []

def get_projects():
    return sorted(task_cmd(["_projects"]))

def get_user_tags():
    return sorted(task_cmd(["_tags"]))

def get_virtual_tags():
    return sorted(task_cmd(["_virtualtags"]))

def get_udas():
    names = []
    for line in task_cmd(["show", "uda"]):
        if line.startswith("uda.") and ".type" in line:
            parts = line.split()
            if len(parts) >= 1:
                name = parts[0].split(".", 1)[1].split(".type")[0]
                names.append(name)
    return sorted(set(names))

# ---------- rc handling ----------

def load_rc():
    coeffs = {}
    if not os.path.exists(RC_PATH):
        return coeffs
    with open(RC_PATH) as f:
        for line in f:
            line = line.split("#", 1)[0].strip()
            if "=" in line:
                k, v = line.split("=", 1)
                try:
                    coeffs[k.strip()] = float(v.strip())
                except ValueError:
                    pass
    return coeffs

def write_rc(coeffs):
    lines = []
    for k in sorted(coeffs):
        base = (
            URGENCY_DEFAULTS.get(k)
            or URGENCY_DEFAULTS.get("urgency.project")
            or URGENCY_DEFAULTS.get("urgency.tags")
            or URGENCY_DEFAULTS.get("urgency.uda")
        )
        if base is not None:
            lines.append(f"{k}={coeffs[k]:.2f}  # default={base}")
        else:
            lines.append(f"{k}={coeffs[k]:.2f}")

    os.makedirs(os.path.dirname(RC_PATH), exist_ok=True)
    with open(RC_PATH, "w") as f:
        f.write("\n".join(lines) + "\n")

# ---------- view builders ----------

def build_view(mode, coeffs):
    view = OrderedDict()

    if mode == "base":
        for k, v in URGENCY_DEFAULTS.items():
            view[k] = (coeffs.get(k, v), v)

    elif mode == "projects":
        base = URGENCY_DEFAULTS["urgency.project"]
        for p in get_projects():
            k = f"urgency.project.{p}"
            view[k] = (coeffs.get(k, base), base)

    elif mode == "tags":
        base = URGENCY_DEFAULTS["urgency.tags"]
        for t in get_user_tags():
            k = f"urgency.tag.{t}"
            view[k] = (coeffs.get(k, base), base)

    elif mode == "virtual-tags":
        base = URGENCY_DEFAULTS["urgency.tags"]
        for vt in get_virtual_tags():
            k = f"urgency.tag.{vt}"
            view[k] = (coeffs.get(k, base), base)

    elif mode == "udas":
        base = URGENCY_DEFAULTS["urgency.uda"]
        for u in get_udas():
            k = f"urgency.uda.{u}"
            view[k] = (coeffs.get(k, base), base)

    return view

# ---------- UI ----------

def main(stdscr):
    curses.curs_set(0)

    use_colors = False
    try:
        curses.start_color()
        curses.use_default_colors()
        curses.init_pair(1, curses.COLOR_RED, -1)
        use_colors = True
    except curses.error:
        pass

    coeffs = load_rc()
    mode = "base"
    selected_key = None
    scroll = 0

    while True:
        stdscr.clear()
        h, w = stdscr.getmaxyx()

        for i, line in enumerate(HELP_TEXT):
            stdscr.addstr(i, 0, line)

        view = build_view(mode, coeffs)
        if not view:
            stdscr.addstr(4, 0, f"No data for mode '{mode}'. Press any key.")
            stdscr.getch()
            mode = "base"
            continue

        items = sorted(view.items(), key=lambda x: x[1][0], reverse=True)
        keys = [k for k, _ in items]

        if selected_key not in keys:
            selected_key = keys[0]

        selected_idx = keys.index(selected_key)

        visible_rows = h - 6
        if selected_idx < scroll:
            scroll = selected_idx
        elif selected_idx >= scroll + visible_rows:
            scroll = selected_idx - visible_rows + 1

        slice_items = items[scroll:scroll + visible_rows]

        values = [v for _, (v, _) in items]
        max_pos = max([v for v in values if v > 0] or [1])
        max_neg = abs(min([v for v in values if v < 0] or [-1]))

        zero_col = LIST_WIDTH + int(max_neg * BAR_SCALE) + 2

        for i, (k, (v, base)) in enumerate(slice_items):
            y = i + 5
            is_sel = (k == selected_key)
            modified = abs(v - base) > 1e-6

            attr = curses.A_REVERSE if is_sel else curses.A_NORMAL
            if modified and use_colors:
                attr |= curses.color_pair(1)

            stdscr.addstr(y, 0, k[:LIST_WIDTH].ljust(LIST_WIDTH), attr)
            stdscr.addstr(y, LIST_WIDTH + 1, f"{v:6.2f}", attr)

            stdscr.addstr(y, zero_col, "│")
            if v >= 0:
                bar = int((v / max_pos) * 20)
                stdscr.addstr(y, zero_col + 1, BAR_CHAR * bar)
            else:
                bar = int((abs(v) / max_neg) * 20)
                stdscr.addstr(y, zero_col - bar, BAR_CHAR * bar)

        ch = stdscr.getch()

        if ch == ord("q"):
            write_rc(coeffs)
            break

        elif ch == curses.KEY_UP:
            selected_key = keys[max(0, selected_idx - 1)]

        elif ch == curses.KEY_DOWN:
            selected_key = keys[min(len(keys) - 1, selected_idx + 1)]

        elif ch == curses.KEY_RIGHT:
            coeffs[selected_key] = view[selected_key][0] + 1.0

        elif ch == curses.KEY_LEFT:
            coeffs[selected_key] = view[selected_key][0] - 1.0

        elif ch in (ord("b"), ord("p"), ord("t"), ord("v"), ord("u")):
            mode = {
                "b": "base",
                "p": "projects",
                "t": "tags",
                "v": "virtual-tags",
                "u": "udas",
            }[chr(ch)]
            selected_key = None
            scroll = 0

if __name__ == "__main__":
    curses.wrapper(main)

