#!/usr/bin/env python3

import curses
import subprocess
from pathlib import Path

# ──────────────────────────────────────────────────────────────
# Paths
# ──────────────────────────────────────────────────────────────

TASK_DIR = Path.home() / ".task"
RC_PATH = TASK_DIR / "config" / "urgency.rc"

# ──────────────────────────────────────────────────────────────
# UI configuration
# ──────────────────────────────────────────────────────────────

BAR_CHAR = "▅"
AXIS_CHAR = "│"

LABEL_WIDTH = 34
VALUE_WIDTH = 7
BAR_WIDTH = 16

STEP = 1.0
HEADER_HEIGHT = 4

# ──────────────────────────────────────────────────────────────
# Canonical urgency defaults (full deck)
# ──────────────────────────────────────────────────────────────

URGENCY_DEFAULTS = {
    "urgency.age": 2.0,
    "urgency.annotations": 1.0,
    "urgency.blocked": -5.0,
    "urgency.blocking": 8.0,
    "urgency.due": 12.0,
    "urgency.next": 15.0,
    "urgency.overdue": 30.0,
    "urgency.priority.H": 6.0,
    "urgency.priority.M": 3.9,
    "urgency.priority.L": 1.8,
    "urgency.project": 1.0,
    "urgency.scheduled": 5.0,
    "urgency.tags": 1.0,
    "urgency.uda": 1.0,
}

# User-modified coefficients
coeffs = {}

# ──────────────────────────────────────────────────────────────
# Load urgency.rc
# ──────────────────────────────────────────────────────────────

def load_rc():
    coeffs.clear()
    if not RC_PATH.exists():
        return

    for line in RC_PATH.read_text().splitlines():
        line = line.strip()
        if not line or line.startswith("#"):
            continue
        if "=" not in line:
            continue

        key, val = line.split("=", 1)
        try:
            coeffs[key.strip()] = float(val.split("#", 1)[0])
        except ValueError:
            pass

# ──────────────────────────────────────────────────────────────
# Write urgency.rc
# ──────────────────────────────────────────────────────────────

def write_rc(view, mode):
    lines = []

    header = [
        "# ------------------------------------------------------------",
        "# Taskwarrior urgency configuration",
        "#",
        "# Generated by urgency-tweaker",
        "# Edit freely; values will be preserved",
        "#",
        "# * indicates modified from default or base",
        "# ------------------------------------------------------------",
        "",
    ]
    lines.extend(header)

    # determine comment text per key
    entries = []
    for key, value in view.items():
        if mode == "base":
            default = URGENCY_DEFAULTS.get(key)
            modified = key in coeffs and coeffs[key] != default
            comment = f"default={default}"
        else:
            base = URGENCY_DEFAULTS["urgency.project"]
            modified = key in coeffs and coeffs[key] != base
            comment = f"base={base}"

        if modified:
            comment += " *"

        entries.append((key, value, comment))

    # alignment
    kv_strings = [f"{k}={v:.1f}" for k, v, _ in entries]
    pad = max(len(s) for s in kv_strings) + 6

    for (key, value, comment), kv in zip(entries, kv_strings):
        line = f"{kv:<{pad}}# {comment}"
        lines.append(line)

    RC_PATH.parent.mkdir(parents=True, exist_ok=True)
    RC_PATH.write_text("\n".join(lines) + "\n")

    load_rc()

# ──────────────────────────────────────────────────────────────
# Taskwarrior helpers
# ──────────────────────────────────────────────────────────────

def get_projects():
    try:
        out = subprocess.check_output(
            ["task", "_projects"],
            stderr=subprocess.DEVNULL,
            text=True
        )
        return [p for p in out.splitlines() if p]
    except Exception:
        return []

# ──────────────────────────────────────────────────────────────
# View builders
# ──────────────────────────────────────────────────────────────

def build_base_view():
    return {k: coeffs.get(k, v) for k, v in URGENCY_DEFAULTS.items()}

def build_project_view():
    base = URGENCY_DEFAULTS["urgency.project"]
    return {
        f"urgency.project.{p}": coeffs.get(f"urgency.project.{p}", base)
        for p in get_projects()
    }

# ──────────────────────────────────────────────────────────────
# Bar rendering
# ──────────────────────────────────────────────────────────────

def render_bar(value, scale):
    half = BAR_WIDTH
    neg = [" "] * half
    pos = [" "] * half

    if scale > 0:
        mag = int(round((abs(value) / scale) * half))
        if value < 0:
            for i in range(min(mag, half)):
                neg[half - 1 - i] = BAR_CHAR
        elif value > 0:
            for i in range(min(mag, half)):
                pos[i] = BAR_CHAR

    return "".join(neg) + AXIS_CHAR + "".join(pos)

# ──────────────────────────────────────────────────────────────
# Curses UI
# ──────────────────────────────────────────────────────────────

def ui(stdscr):
    curses.curs_set(0)
    stdscr.keypad(True)

    load_rc()

    mode = "base"
    selected_key = None
    status = ""

    while True:
        stdscr.erase()

        if mode == "base":
            view = build_base_view()
            title = "Urgency Tweaker — Base coefficients (p: projects, w: write, q: quit)"
        else:
            view = build_project_view()
            title = "Urgency Tweaker — Project coefficients (p: base, w: write, q: quit)"

        keys = sorted(view.keys(), key=lambda k: view[k], reverse=True)

        if not keys:
            stdscr.addstr(0, 0, "No data to display")
            stdscr.refresh()
            stdscr.getch()
            return

        if selected_key not in keys:
            selected_key = keys[0]

        selected_idx = keys.index(selected_key)
        scale = max(abs(v) for v in view.values()) or 1.0

        # Header
        stdscr.addstr(0, 0, title)
        stdscr.addstr(1, 0, "Arrow keys adjust values")
        stdscr.addstr(2, 0, "* indicates modified value")

        # Rows
        for idx, key in enumerate(keys):
            y = HEADER_HEIGHT + idx
            if y >= curses.LINES - 2:
                break

            val = view[key]
            marker = "*" if key in coeffs else " "

            left = f"{key:<{LABEL_WIDTH}} {val:>{VALUE_WIDTH}.1f} {marker} "
            bar = render_bar(val, scale)

            if idx == selected_idx:
                stdscr.addstr(y, 0, left, curses.A_REVERSE)
                stdscr.addstr(y, len(left), bar)
            else:
                stdscr.addstr(y, 0, left)
                stdscr.addstr(y, len(left), bar)

        if status:
            stdscr.addstr(curses.LINES - 1, 0, status)
            status = ""

        stdscr.refresh()

        ch = stdscr.getch()

        if ch in (ord("q"), 27):
            break

        elif ch == ord("p"):
            mode = "projects" if mode == "base" else "base"

        elif ch == ord("w"):
            write_rc(view, mode)
            status = "urgency.rc written"

        elif ch == curses.KEY_UP:
            selected_key = keys[max(0, selected_idx - 1)]

        elif ch == curses.KEY_DOWN:
            selected_key = keys[min(len(keys) - 1, selected_idx + 1)]

        elif ch == curses.KEY_RIGHT:
            coeffs[selected_key] = view[selected_key] + STEP

        elif ch == curses.KEY_LEFT:
            coeffs[selected_key] = view[selected_key] - STEP

# ──────────────────────────────────────────────────────────────

def main():
    curses.wrapper(ui)

if __name__ == "__main__":
    main()

